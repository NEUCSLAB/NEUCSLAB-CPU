# 计数器与时钟

在数字系统中，常用计数器来记录系统的工作状态，本实验复习了计数器的工作原理，通过介绍几种简单计数器的工作过程和设计方法、以及开发板系统时钟的使用，学习计数器的设计和定时器的工作原理。

## 异步计数器

通过将D触发器的输出端接到下一级触发器的时钟端实现，在低频电路上可行，但在高频电路中对时钟信号的纯净度要求较高，如果信号中存在毛刺可能会导致异常结果。  

![异步计数器](/img/Async_counter.png "异步计数器")

## 同步计数器

通过加法器对计数器的结果进行计算，之后通过触发器对数据进行采集并保持，这种电路可靠性强，且控制信号更加丰富。

![同步计数器](/img/Sync_counter.png "同步计数器")

根据以上电路图可以写出以下描述代码

```verilog
module counter_4b(
    input               clk_i,
    input               rst_i,

    input               ce_i,

    output  reg [3:0]   q_o
);

    wire        [3:0]   add_result;

    assign  add_result = q_o + 4'b0001;

    always @(posedge clk_i or posedge rst_i) begin
        if(rst_i) begin
            q_o <= 4'b0000;
        end else begin
            if(ce_i) begin
                q_o <= add_result;
            end else begin
                q_o <= q_o;
            end
        end
    end

endmodule
```

标准的组合逻辑+时序逻辑代码，层级分明。  

当然，也可以这么写

```verilog
module counter_4b(
    input               clk_i,
    input               rst_i,

    input               ce_i,

    output  reg [3:0]   q_o
);

    always @(posedge clk_i or posedge rst_i) begin
        if(rst_i) begin
            q_o <= 4'b0000;
        end else begin
            if(ce_i) begin
                q_o <= q_o + 4'b0001;
            end else begin
                q_o <= q_o;
            end
        end
    end

endmodule
```
请自己思考一下两者有何区别。

## 计数

上面给出的计数器实际功能是对输入的`ce_i`信号进行计数，计数的结果会晚于`ce_i`实际拉高的周期数一拍。思考一下这个功能究竟有什么用，回想一下处理器中的PC寄存器，它跟这章又有什么关系。  

## 时钟

现在来到了最重要的概念，时钟究竟是什么，又从哪来。 

在前面的章节，我每次提到时钟的时候，提到时序逻辑的时候，都会讲一句话

> 对齐数据

D触发器在时钟上升沿，将输入端的数据搬运到输出端。当电路中所有D触发器都使用同一个时钟信号控制时，就可以保证所有的时序逻辑在时钟上升沿时完成数据更新，虽然这个更新过程受到使能信号控制，但也保证了过程可控。  

那么，我们每次写时序逻辑的时候都要写的clk和rst，又从哪来呢？

首先明确一点，FPGA内部是没有时钟的，实际的CPU也没有，他们都需要外部的晶振作为时钟输入，在内部通过锁相环等结构进行倍频，从而将时钟频率调整到自己的工作频率。这就是为什么现代CPU的工作频率一直在变化，内部的倍频电路一直在根据工作情况调整着工作频率。  

对于我们的开发板而言，我们需要在完成综合后，通过I/O Planning选定时钟管脚，这一管脚通常连接到开发板上的固定晶振，需要参考开发板原理图才能确定具体管脚。详细内容可以参考FPGA开发进阶->物理约束章节的相关内容。  

而rst信号，是指外部复位信号，这个信号定义为将所有逻辑恢复到初始状态的信号，根据开发板不同分为高电平有效与低电平有效，xilinx的开发板大多数为高电平复位有效。一般这个复位信号需要接到一个按钮或者一个能区分高低电平的外部输入引脚，一定不要让这个引脚悬空，否则会导致大量时序逻辑失效。  

再简单说一下外部复位和上电复位的区别。在开发板上电时，芯片内部会对所有的时序逻辑初始化，有些复杂的ip核还有自己的一套复位逻辑，但这个复位并不是通过我们所写的rst信号来完成的，比如例化FDRE时的参数INIT就定义了上电时的初始值。上电初始化的逻辑几乎是用户无法参与的。而外部复位是由用户控制的，当用户需要将电路复位时可以通过这一外部复位引脚完成，当然部分结构也可以通过不接入复位信号来逃开外部复位，但仍然逃不开上电复位过程。  

## 练习

参考74LS161的数据手册，设计一个同步四位二进制计数器，要求带有同步置数功能。想想PC指针与这个计数器有什么关系。  

如果你感觉到困难，可以参考一下下面的电路图  

![带置位的同步计数器](/img/Sync_counter_load.png "带置位的同步计数器")

